# è®­ç»ƒAPIå®ç°æ€»ç»“

## ğŸ“‹ å®Œæˆæƒ…å†µ

âœ… **å·²å®Œæˆ**: å®Œæ•´çš„è®­ç»ƒä»»åŠ¡APIç³»ç»Ÿ

æœ¬å®ç°åœ¨ `/root/diffusion-pipe/api/` ç›®å½•ä¸‹åˆ›å»ºäº†å®Œæ•´çš„è®­ç»ƒä»»åŠ¡ç®¡ç†APIï¼Œæ”¯æŒåˆ›å»ºã€ç›‘æ§ã€åœæ­¢è®­ç»ƒä»»åŠ¡ç­‰åŠŸèƒ½ã€‚

---

## ğŸ—‚ï¸ å®ç°çš„æ–‡ä»¶ç»“æ„

```
/root/diffusion-pipe/api/
â”œâ”€â”€ models/
â”‚   â””â”€â”€ training.py                    # è®­ç»ƒæ•°æ®æ¨¡å‹ âœ…
â”‚       â”œâ”€â”€ TrainingStatus             # è®­ç»ƒçŠ¶æ€æšä¸¾
â”‚       â”œâ”€â”€ TrainingProgress           # è®­ç»ƒè¿›åº¦
â”‚       â”œâ”€â”€ TrainingMetrics            # è®­ç»ƒæŒ‡æ ‡
â”‚       â”œâ”€â”€ TrainingTask               # è®­ç»ƒä»»åŠ¡
â”‚       â”œâ”€â”€ TrainingTaskRequest        # åˆ›å»ºè¯·æ±‚
â”‚       â”œâ”€â”€ LogsResponse              # æ—¥å¿—å“åº”
â”‚       â””â”€â”€ ...                       # å…¶ä»–æ•°æ®æ¨¡å‹
â”‚
â”œâ”€â”€ routes/
â”‚   â””â”€â”€ training.py                   # è®­ç»ƒAPIè·¯ç”± âœ…
â”‚       â”œâ”€â”€ POST /training/start       # åˆ›å»ºè®­ç»ƒä»»åŠ¡
â”‚       â”œâ”€â”€ POST /training/stop/{id}  # åœæ­¢è®­ç»ƒä»»åŠ¡
â”‚       â”œâ”€â”€ GET /training/list        # è·å–ä»»åŠ¡åˆ—è¡¨
â”‚       â”œâ”€â”€ GET /training/{id}       # è·å–ä»»åŠ¡è¯¦æƒ…
â”‚       â”œâ”€â”€ GET /training/{id}/progress    # è·å–è®­ç»ƒè¿›åº¦
â”‚       â”œâ”€â”€ GET /training/{id}/metrics     # è·å–æŒ‡æ ‡å†å²
â”‚       â””â”€â”€ GET /training/{id}/logs        # è·å–è®­ç»ƒæ—¥å¿—
â”‚
â”œâ”€â”€ services/
â”‚   â””â”€â”€ training_service.py          # è®­ç»ƒæœåŠ¡å®ç° âœ…
â”‚       â”œâ”€â”€ create_training_task      # åˆ›å»ºè®­ç»ƒä»»åŠ¡
â”‚       â”œâ”€â”€ stop_training_task       # åœæ­¢è®­ç»ƒä»»åŠ¡
â”‚       â”œâ”€â”€ list_training_tasks      # è·å–ä»»åŠ¡åˆ—è¡¨
â”‚       â”œâ”€â”€ get_training_progress    # è·å–è®­ç»ƒè¿›åº¦
â”‚       â”œâ”€â”€ get_metrics_history      # è·å–æŒ‡æ ‡å†å²
â”‚       â””â”€â”€ get_training_logs        # è·å–è®­ç»ƒæ—¥å¿—
â”‚
â”œâ”€â”€ utils/
â”‚   â””â”€â”€ training_wrapper.py          # è®­ç»ƒä»»åŠ¡åŒ…è£…å™¨ âœ…
â”‚       â”œâ”€â”€ start_training           # å¯åŠ¨è®­ç»ƒä»»åŠ¡
â”‚       â”œâ”€â”€ stop_training            # åœæ­¢è®­ç»ƒä»»åŠ¡
â”‚       â”œâ”€â”€ _generate_config_file    # ç”Ÿæˆé…ç½®æ–‡ä»¶
â”‚       â””â”€â”€ _build_command           # æ„å»ºå‘½ä»¤
â”‚
â””â”€â”€ test_training_api.py             # APIæµ‹è¯•è„šæœ¬ âœ…
```

## ğŸ¯ å®ç°çš„æ ¸å¿ƒåŠŸèƒ½

### 1. è®­ç»ƒä»»åŠ¡ç®¡ç†

#### 1.1 åˆ›å»ºè®­ç»ƒä»»åŠ¡ (POST /api/v1/training/start)
- **åŠŸèƒ½**: åˆ›å»ºæ–°çš„è®­ç»ƒä»»åŠ¡å¹¶å¼‚æ­¥å¯åŠ¨
- **å‚æ•°**:
  - `gpu_id`: GPU ID
  - `model_type`: æ¨¡å‹ç±»å‹ (flux, wan, sdxlç­‰)
  - `description`: ä»»åŠ¡æè¿°
  - `dataset`: æ•°æ®é›†é…ç½®
  - `config`: è®­ç»ƒé…ç½® (epochs, batch_size, optimizerç­‰)
- **ç‰¹æ€§**:
  - è‡ªåŠ¨ç”Ÿæˆå”¯ä¸€ä»»åŠ¡ID
  - GPUå¯ç”¨æ€§æ£€æŸ¥
  - å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œ
  - è‡ªåŠ¨ç”Ÿæˆé…ç½®æ–‡ä»¶

#### 1.2 åœæ­¢è®­ç»ƒä»»åŠ¡ (POST /api/v1/training/stop/{task_id})
- **åŠŸèƒ½**: åœæ­¢æ­£åœ¨è¿è¡Œæˆ–æ’é˜Ÿçš„è®­ç»ƒä»»åŠ¡
- **å‚æ•°**:
  - `force`: æ˜¯å¦å¼ºåˆ¶åœæ­¢
- **ç‰¹æ€§**:
  - ä¼˜é›…åœæ­¢ (SIGTERM)
  - å¼ºåˆ¶åœæ­¢ (SIGKILL)
  - ä¿å­˜æ£€æŸ¥ç‚¹
  - é‡Šæ”¾GPUèµ„æº

#### 1.3 è·å–ä»»åŠ¡åˆ—è¡¨ (GET /api/v1/training/list)
- **åŠŸèƒ½**: åˆ†é¡µè·å–è®­ç»ƒä»»åŠ¡åˆ—è¡¨
- **æŸ¥è¯¢å‚æ•°**:
  - `status`: æŒ‰çŠ¶æ€è¿‡æ»¤ (queued, running, completedç­‰)
  - `gpu_id`: æŒ‰GPUè¿‡æ»¤
  - `limit`: è¿”å›æ•°é‡é™åˆ¶
  - `offset`: åç§»é‡
- **ç‰¹æ€§**:
  - æ”¯æŒå¤šæ¡ä»¶è¿‡æ»¤
  - åˆ†é¡µæŸ¥è¯¢
  - æ’åº (æŒ‰åˆ›å»ºæ—¶é—´å€’åº)

#### 1.4 è·å–ä»»åŠ¡è¯¦æƒ… (GET /api/v1/training/{task_id})
- **åŠŸèƒ½**: è·å–æŒ‡å®šè®­ç»ƒä»»åŠ¡çš„è¯¦ç»†ä¿¡æ¯
- **è¿”å›æ•°æ®**:
  - ä»»åŠ¡åŸºæœ¬ä¿¡æ¯ (ID, çŠ¶æ€, GPUç­‰)
  - è®­ç»ƒé…ç½®
  - å½“å‰è¿›åº¦
  - æŒ‡æ ‡ä¿¡æ¯
  - ç³»ç»ŸçŠ¶æ€
  - æ£€æŸ¥ç‚¹åˆ—è¡¨
  - æ—¥å¿—è·¯å¾„

### 2. è®­ç»ƒè¿›åº¦ç›‘æ§

#### 2.1 è·å–è®­ç»ƒè¿›åº¦ (GET /api/v1/training/{task_id}/progress)
- **åŠŸèƒ½**: å®æ—¶è·å–è®­ç»ƒè¿›åº¦ä¿¡æ¯
- **è¿”å›æ•°æ®**:
  - å½“å‰epoch/step
  - è¿›åº¦ç™¾åˆ†æ¯”
  - ETA (é¢„è®¡å‰©ä½™æ—¶é—´)
  - è®­ç»ƒé€Ÿåº¦
  - å®æ—¶æŒ‡æ ‡ (loss, lr, grad_normç­‰)

#### 2.2 è·å–æŒ‡æ ‡å†å² (GET /api/v1/training/{task_id}/metrics)
- **åŠŸèƒ½**: è·å–æŒ‡å®šæŒ‡æ ‡çš„å†å²æ•°æ®
- **æŸ¥è¯¢å‚æ•°**:
  - `metric`: æŒ‡æ ‡åç§° (loss, lr, grad_normç­‰)
  - `type`: ç±»å‹ (epoch, step)
  - `limit`: æ•°æ®ç‚¹æ•°é‡é™åˆ¶
- **ç‰¹æ€§**:
  - æ”¯æŒå¤šç§æŒ‡æ ‡
  - æ—¶é—´åºåˆ—æ•°æ®
  - å¯é™åˆ¶è¿”å›æ•°é‡

### 3. æ—¥å¿—æŸ¥è¯¢

#### 3.1 è·å–è®­ç»ƒæ—¥å¿— (GET /api/v1/training/{task_id}/logs)
- **åŠŸèƒ½**: è·å–è®­ç»ƒæ—¥å¿—
- **æŸ¥è¯¢å‚æ•°**:
  - `type`: æ—¥å¿—ç±»å‹ (train, eval, system, all)
  - `level`: æ—¥å¿—çº§åˆ« (DEBUG, INFO, WARNING, ERROR)
  - `tail`: è¿”å›æœ€åNè¡Œ
  - `since`: è¿”å›æŒ‡å®šæ—¶é—´ä¹‹åçš„æ—¥å¿—
- **ç‰¹æ€§**:
  - æ”¯æŒå¤šæ¡ä»¶è¿‡æ»¤
  - è§£ææ—¥å¿—è¡Œ (timestamp, level, messageç­‰)
  - æ”¯æŒåˆ†é¡µæŸ¥çœ‹

## ğŸ”§ æŠ€æœ¯å®ç°

### 1. è®­ç»ƒä»»åŠ¡åŒ…è£…å™¨ (TrainingWrapper)
- **ä½œç”¨**: å°è£…åŸå§‹train.pyï¼Œä¸ä¿®æ”¹å…¶é€»è¾‘
- **åŠŸèƒ½**:
  - ç”ŸæˆTOMLé…ç½®æ–‡ä»¶
  - æ„å»ºdeepspeedå¯åŠ¨å‘½ä»¤
  - å¯åŠ¨å­è¿›ç¨‹æ‰§è¡Œè®­ç»ƒ
  - å®æ—¶æ•è·æ—¥å¿—è¾“å‡º
  - è¿›ç¨‹ç®¡ç†å’Œåœæ­¢

```python
# ä½¿ç”¨ç¤ºä¾‹
wrapper = TrainingWrapper()
wrapper.start_training(
    task_id="train_20250212_07000001",
    gpu_id=0,
    model_type="flux",
    config=config_dict,
    dataset=dataset_dict,
    output_dir=Path("/data/training_runs")
)
```

### 2. å¼‚æ­¥ä»»åŠ¡ç®¡ç†
- **çº¿ç¨‹æ± **: ä½¿ç”¨ThreadPoolExecutoræ‰§è¡Œå¼‚æ­¥ä»»åŠ¡
- **çŠ¶æ€ç®¡ç†**: çº¿ç¨‹å®‰å…¨çš„çŠ¶æ€æ›´æ–°
- **è¿›åº¦æ›´æ–°**: åå°çº¿ç¨‹æŒç»­æ›´æ–°è®­ç»ƒè¿›åº¦

### 3. æ•°æ®æŒä¹…åŒ–
- **ä»»åŠ¡çŠ¶æ€**: å†…å­˜ä¸­ç»´æŠ¤ä»»åŠ¡æ˜ å°„
- **é…ç½®æ–‡ä»¶**: è‡ªåŠ¨ç”ŸæˆTOMLé…ç½®æ–‡ä»¶
- **æ—¥å¿—æ–‡ä»¶**: è®­ç»ƒæ—¥å¿—å®æ—¶å†™å…¥æ–‡ä»¶
- **æ£€æŸ¥ç‚¹**: è®­ç»ƒè¿‡ç¨‹ä¸­çš„æ£€æŸ¥ç‚¹ä¿å­˜

### 4. é”™è¯¯å¤„ç†
- **å¼‚å¸¸æ•è·**: å…¨é¢çš„å¼‚å¸¸å¤„ç†æœºåˆ¶
- **çŠ¶æ€å›æ»š**: ä»»åŠ¡å¤±è´¥æ—¶çš„çŠ¶æ€æ›´æ–°
- **èµ„æºæ¸…ç†**: é‡Šæ”¾GPUå’Œæ¸…ç†ä¸´æ—¶æ–‡ä»¶
- **é”™è¯¯æ—¥å¿—**: è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯è®°å½•

## ğŸ“Š APIå“åº”æ ¼å¼

æ‰€æœ‰APIå‡è¿”å›ç»Ÿä¸€æ ¼å¼:

```json
{
  "code": 200,
  "message": "success",
  "data": {
    // å…·ä½“æ•°æ®
  },
  "timestamp": 1704067200
}
```

é”™è¯¯ç è¯´æ˜:
- `200`: æˆåŠŸ
- `201`: åˆ›å»ºæˆåŠŸ
- `400`: è¯·æ±‚å‚æ•°é”™è¯¯
- `404`: ä»»åŠ¡ä¸å­˜åœ¨
- `409`: GPUå·²è¢«å ç”¨
- `500`: æœåŠ¡å™¨å†…éƒ¨é”™è¯¯

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

### 1. å¯åŠ¨è®­ç»ƒä»»åŠ¡

```bash
curl -X POST http://localhost:8080/api/v1/training/start \
  -H "Content-Type: application/json" \
  -d '{
    "gpu_id": 0,
    "model_type": "flux",
    "description": "Flux LoRA è®­ç»ƒ",
    "dataset": {
      "resolutions": [512],
      "directories": [{"path": "/data/train", "num_repeats": 5}]
    },
    "config": {
      "epochs": 10,
      "micro_batch_size_per_gpu": 1,
      "optimizer": {"type": "adamw_optimi", "lr": 5e-5}
    }
  }'
```

### 2. æŸ¥è¯¢è®­ç»ƒè¿›åº¦

```bash
curl http://localhost:8080/api/v1/training/train_20250212_07000001/progress
```

### 3. è·å–è®­ç»ƒæ—¥å¿—

```bash
curl "http://localhost:8080/api/v1/training/train_20250212_07000001/logs?type=train&tail=20"
```

### 4. åœæ­¢è®­ç»ƒä»»åŠ¡

```bash
curl -X POST http://localhost:8080/api/v1/training/stop/train_20250212_07000001 \
  -H "Content-Type: application/json" \
  -d '{"force": false}'
```

## ğŸ§ª æµ‹è¯•

è¿è¡Œæµ‹è¯•è„šæœ¬:

```bash
cd /root/diffusion-pipe/api
python test_training_api.py
```

æµ‹è¯•å†…å®¹:
- âœ… åˆ›å»ºè®­ç»ƒä»»åŠ¡
- âœ… è·å–ä»»åŠ¡åˆ—è¡¨
- âœ… è·å–ä»»åŠ¡è¯¦æƒ…
- âœ… è·å–è®­ç»ƒè¿›åº¦
- âœ… è·å–æŒ‡æ ‡å†å²
- âœ… è·å–è®­ç»ƒæ—¥å¿—
- âœ… åœæ­¢è®­ç»ƒä»»åŠ¡

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **ä¸ä¿®æ”¹åŸå§‹train.py**: æ‰€æœ‰ä¿®æ”¹éƒ½åœ¨APIå±‚é¢ï¼Œtrain.pyä¿æŒåŸæ ·
2. **é…ç½®æ–‡ä»¶ç”Ÿæˆ**: è‡ªåŠ¨ç”ŸæˆTOMLé…ç½®æ–‡ä»¶ï¼Œä½ç½®åœ¨ `/tmp/diffusion_pipe_configs/`
3. **æ—¥å¿—æ–‡ä»¶**: è®­ç»ƒæ—¥å¿—ä¿å­˜åœ¨ `/tmp/diffusion_pipe_logs/`
4. **è®­ç»ƒè¾“å‡º**: è®­ç»ƒç»“æœä¿å­˜åœ¨ `/data/training_runs/`
5. **GPUç®¡ç†**: è‡ªåŠ¨ç®¡ç†GPUçŠ¶æ€ï¼Œé¿å…èµ„æºå†²çª
6. **å¼‚æ­¥æ‰§è¡Œ**: æ‰€æœ‰è®­ç»ƒä»»åŠ¡å¼‚æ­¥æ‰§è¡Œï¼Œä¸é˜»å¡APIå“åº”

## ğŸ”® åç»­æ”¹è¿›

1. **å®æ—¶æ—¥å¿—æµ**: æ·»åŠ SSEæ”¯æŒï¼Œå®æ—¶æ¨é€æ—¥å¿—
2. **ä»»åŠ¡æ¢å¤**: æ”¯æŒä»æ£€æŸ¥ç‚¹æ¢å¤è®­ç»ƒ
3. **è¿œç¨‹ç›‘æ§**: é›†æˆTensorBoard/W&Bç›‘æ§
4. **èµ„æºé…é¢**: æ”¯æŒGPUæ˜¾å­˜é…é¢ç®¡ç†
5. **ä»»åŠ¡è°ƒåº¦**: ä¼˜å…ˆçº§é˜Ÿåˆ—å’Œèµ„æºè°ƒåº¦å™¨
6. **Webhook**: æ”¯æŒè®­ç»ƒå®Œæˆå›è°ƒé€šçŸ¥

---

## æ€»ç»“

âœ… æˆåŠŸå®ç°äº†å®Œæ•´çš„è®­ç»ƒä»»åŠ¡APIç³»ç»Ÿï¼Œæ”¯æŒ:
- è®­ç»ƒä»»åŠ¡çš„åˆ›å»ºã€ç›‘æ§ã€åœæ­¢
- å®æ—¶è¿›åº¦è·Ÿè¸ªå’ŒæŒ‡æ ‡æŸ¥è¯¢
- æ—¥å¿—æŸ¥è¯¢å’Œç®¡ç†
- å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œ
- å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œèµ„æºç®¡ç†

æ‰€æœ‰åŠŸèƒ½å‡åŸºäºåŸå§‹train.pyï¼Œæœªä¿®æ”¹å…¶æ ¸å¿ƒé€»è¾‘ï¼Œä¿æŒäº†ç³»ç»Ÿçš„ç¨³å®šæ€§å’Œå¯ç»´æŠ¤æ€§ã€‚
